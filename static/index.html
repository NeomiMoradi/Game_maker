
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kahoot-Style Demo (Difficulty)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .card { border:1px solid #ddd; border-radius:12px; padding:16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); flex:1; min-width: 300px; }
    button { padding:10px 16px; border-radius:10px; border:1px solid #ccc; cursor:pointer; }
    select, input { padding:8px; border-radius:8px; border:1px solid #ccc; }
    h1 { margin-top: 0; }
    .choices button { display:block; margin:8px 0; width:100%; }
    .ok { color: green; }
    .err { color: #b00020; }
    .leaderboard table { width:100%; border-collapse: collapse; }
    .leaderboard th, .leaderboard td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
    .meta { color:#666; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h1>üèÜ Kahoot-Style Office Trivia ‚Äî Difficulty Modes</h1>
  <div class="row">
    <div class="card">
      <h2>1) Create Game</h2>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <label>Topic: <select id="topic"></select></label>
        <label>Difficulty: 
          <select id="difficulty">
            <option>Any</option>
            <option>Easy</option>
            <option>Medium</option>
            <option>Hard</option>
          </select>
        </label>
        <label># Questions: <input id="num" type="number" min="1" max="20" value="10" style="width:80px"/></label>
      </div>
      <button id="create">Create Game</button>
      <div id="createMsg" class="meta"></div>
      <p>Game ID: <span id="gameId">-</span></p>
    </div>

    <div class="card">
      <h2>2) Join Players</h2>
      <p>Choose username and join the game:</p>
      <select id="username">
        <option>Roni</option>
        <option>Tomer</option>
        <option>Dani</option>
        <option>Mor</option>
      </select>
      <button id="join">Join</button>
      <div id="joinMsg"></div>
    </div>

    <div class="card">
      <h2>3) Question</h2>
      <p id="qState">Question: <span id="qIndex">0</span>/<span id="qTotal">0</span></p>
      <div id="qText"><em>No question yet</em></div>
      <div class="meta">Difficulty: <span id="qDiff">-</span></div>
      <div class="choices" id="choices"></div>
      <div id="answerMsg"></div>
      <button id="next">Next Question ‚û°Ô∏è</button>
    </div>

    <div class="card leaderboard">
      <h2>4) Leaderboard</h2>
      <button id="refreshLB">Refresh Leaderboard</button>
      <table>
        <thead><tr><th>Player</th><th>Score</th></tr></thead>
        <tbody id="lbBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const el = (id)=>document.getElementById(id);
    let gameId = null;

    async function loadTopics(){
      const res = await fetch('/api/kahoot/topics');
      const data = await res.json();
      const sel = el('topic');
      data.forEach(t=>{
        const o = document.createElement('option');
        o.value = t.id; o.textContent = t.name;
        sel.appendChild(o);
      });
    }

    async function createGame(){
      const topic_id = Number(el('topic').value);
      const difficulty = el('difficulty').value;
      const num_questions = Number(el('num').value);
      const res = await fetch('/api/kahoot/games/create', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({topic_id, difficulty, num_questions})
      });
      const data = await res.json();
      if(res.ok){
        gameId = data.game_id;
        el('gameId').textContent = gameId;
        el('createMsg').textContent = `Created with ${data.question_count} questions ‚Äî Difficulty: ${data.difficulty}`;
        const stateRes = await fetch(`/api/kahoot/games/${gameId}/state`);
        const state = await stateRes.json();
        el('qTotal').textContent = state.total_questions;
        await loadQuestion();
        await refreshLB();
      } else {
        el('createMsg').innerHTML = '<span class="err">'+(data.error||'Error')+'</span>';
      }
    }

    async function join(){
      if(!gameId){ el('joinMsg').innerHTML = '<span class="err">Create a game first</span>'; return; }
      const username = el('username').value;
      const res = await fetch(`/api/kahoot/games/${gameId}/join`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({username})
      });
      const data = await res.json();
      el('joinMsg').innerHTML = res.ok ? '<span class="ok">Joined as '+username+'</span>' : '<span class="err">'+(data.error||'Error')+'</span>';
      await refreshLB();
    }

    function renderQuestion(q){
      if(!q){ el('qText').innerHTML = '<em>No question</em>'; return; }
      el('qIndex').textContent = q.index+1;
      el('qText').textContent = q.text;
      el('qDiff').textContent = q.difficulty;
      const choices = el('choices'); choices.innerHTML='';
      ['A','B','C','D'].forEach(letter=>{
        const btn = document.createElement('button');
        btn.textContent = letter + ') ' + q.choices[letter];
        btn.onclick = ()=>answer(q, letter);
        choices.appendChild(btn);
      });
      el('answerMsg').innerHTML = '';
    }

    async function loadQuestion(){
      if(!gameId){ return; }
      const res = await fetch(`/api/kahoot/games/${gameId}/question`);
      const data = await res.json();
      if(res.ok){ renderQuestion(data); }
    }

    async function answer(q, selected){
      const username = el('username').value;
      if(!gameId){ return; }
      const res = await fetch(`/api/kahoot/games/${gameId}/answer`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({username, question_id: q.question_id, selected})
      });
      const data = await res.json();
      if(res.ok){
        el('answerMsg').innerHTML = data.correct ? `<span class="ok">Correct! +${data.points_awarded} (${data.difficulty})</span>` : '<span class="err">Wrong!</span>';
        await refreshLB();
      } else {
        el('answerMsg').innerHTML = '<span class="err">'+(data.error||'Error')+'</span>';
      }
    }

    async function nextQuestion(){
      if(!gameId){ return; }
      const res = await fetch(`/api/kahoot/games/${gameId}/next`, {method:'POST'});
      await loadQuestion();
    }

    async function refreshLB(){
      if(!gameId){ return; }
      const res = await fetch(`/api/kahoot/games/${gameId}/leaderboard`);
      const data = await res.json();
      const tbody = el('lbBody'); tbody.innerHTML='';
      data.forEach(row=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.username}</td><td>${row.score}</td>`;
        tbody.appendChild(tr);
      });
    }

    el('create').onclick = createGame;
    el('join').onclick = join;
    el('next').onclick = nextQuestion;
    el('refreshLB').onclick = refreshLB;

    loadTopics();
  </script>
</body>
</html>
